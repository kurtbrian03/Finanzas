name: PINPON Create Remote Repo

on:
  workflow_dispatch:
    inputs:
      repo_name:
        description: "Nombre del repositorio remoto"
        required: false
        default: "pinpon-modulo-compras"
      private:
        description: "Repositorio privado"
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  create-remote:
    name: Create remote repo (idempotent)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configurar Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Crear repositorio remoto (si no existe)
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:GITHUB_TOKEN)) {
            Write-Host "[WARN] No hay token disponible para crear repo remoto."
            exit 0
          }

          ./scripts/create_remote_repo.ps1 -RepoName "${{ inputs.repo_name }}" -Private:${{ inputs.private }}

      - name: Validar estado final remoto
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:GITHUB_TOKEN)) {
            Write-Host "[WARN] No hay token para validar estado remoto"
            exit 0
          }

          $headers = @{
            Authorization = "Bearer $env:GITHUB_TOKEN"
            Accept = "application/vnd.github+json"
            "X-GitHub-Api-Version" = "2022-11-28"
          }

          $user = Invoke-RestMethod -Method Get -Uri "https://api.github.com/user" -Headers $headers
          $owner = $user.login
          $repoName = "${{ inputs.repo_name }}"
          $resp = Invoke-WebRequest -Method Get -Uri "https://api.github.com/repos/$owner/$repoName" -Headers $headers

          if ($resp.StatusCode -ne 200) {
            throw "Validaci√≥n HTTP fallida para repositorio remoto"
          }

          Write-Host "Repo remoto validado: https://github.com/$owner/$repoName"
